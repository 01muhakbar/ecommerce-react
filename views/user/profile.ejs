<%- include('../partials/header') %>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">Profil Saya</h1>
  <form id="profileForm" class="bg-white p-8 rounded-lg shadow-md max-w-lg mx-auto">
    <div class="mb-4">
      <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
      <input type="text" id="username" name="username" value="<%= user.name %>" readonly
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 cursor-not-allowed" />
      <p class="text-gray-600 text-xs italic mt-1">Username Anda adalah nama tampilan Anda.</p>
    </div>

    <div class="mb-4">
      <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Nama Lengkap</label>
      <input type="text" id="name" name="name" value="<%= user.name %>" required
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>

    <div class="mb-4">
      <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
      <input type="email" id="email" name="email" value="<%= user.email %>" required
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>

    <div class="mb-4">
      <label for="phoneNumber" class="block text-gray-700 text-sm font-bold mb-2">Nomor Telepon</label>
      <input type="tel" id="phoneNumber" name="phoneNumber" value="<%= user.phoneNumber || '' %>"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>

    <div class="mb-4">
      <label for="gender" class="block text-gray-700 text-sm font-bold mb-2">Jenis Kelamin</label>
      <select id="gender" name="gender"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        <option value="">Pilih Jenis Kelamin</option>
        <option value="Laki-laki" <%= user.gender === 'Laki-laki' ? 'selected' : '' %>>Laki-laki</option>
        <option value="Perempuan" <%= user.gender === 'Perempuan' ? 'selected' : '' %>>Perempuan</option>
        <option value="Lainnya" <%= user.gender === 'Lainnya' ? 'selected' : '' %>>Lainnya</option>
      </select>
    </div>

    <div class="mb-6">
      <label for="dateOfBirth" class="block text-gray-700 text-sm font-bold mb-2">Tanggal Lahir</label>
      <input type="date" id="dateOfBirth" name="dateOfBirth" value="<%= user.dateOfBirth || '' %>"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>

    <% if (user.role === 'penjual') { %>
    <div class="mb-6">
      <label for="storeName" class="block text-gray-700 text-sm font-bold mb-2">Nama Toko</label>
      <input type="text" id="storeName" name="storeName" value="<%= user.storeName || '' %>"
             class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
    </div>
    <% } %>

    <div class="flex items-center justify-between">
      <button type="submit"
              class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
        Simpan Perubahan
      </button>
    </div>
  </form>

  <div class="mt-6 max-w-lg mx-auto">
    <a href="/dashboard" class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
      Kembali
    </a>
  </div>
</div>

<!-- Popup Notification -->
<div id="notification-popup" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden">
  <span id="notification-message"></span>
</div>

<%- include('../partials/footer') %>

<script>
  const notificationPopup = document.getElementById('notification-popup');
  const notificationMessage = document.getElementById('notification-message');

  function showNotification(message, isSuccess = true) {
    notificationMessage.textContent = message;
    if (isSuccess) {
      notificationPopup.classList.remove('bg-red-500');
      notificationPopup.classList.add('bg-green-500');
    } else {
      notificationPopup.classList.remove('bg-green-500');
      notificationPopup.classList.add('bg-red-500');
    }
    notificationPopup.classList.remove('hidden');
    setTimeout(() => {
      notificationPopup.classList.add('hidden');
    }, 3000); // Hide after 3 seconds
  }

  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/v1/users/account/profile', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        showNotification(result.message, true);
        // Optionally, update UI or redirect
      } else {
        showNotification('Error: ' + result.message, false);
      }
    } catch (error) {
      console.error('Error updating profile:', error);
      showNotification('Terjadi kesalahan saat memperbarui profil.', false);
    }
  });
</script>
